<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   connect-src ws://127.0.0.1:8000 http://127.0.0.1:8000 'self';
                   style-src 'self' 'unsafe-inline';">
    <title>Endpoint Security Tool</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- ── Workspace Launcher Overlay ─────────────────────────────── -->
<div id="workspace-launcher">
    <div class="launcher-card">
        <h1 class="launcher-title">Endpoint Security Tool</h1>
        <p class="launcher-subtitle">Select or create a workspace</p>
        <div class="launcher-create">
            <input type="text" id="ws-new-name" placeholder="New workspace name..." spellcheck="false">
            <button id="btn-ws-create">Create</button>
        </div>
        <div id="ws-list" class="launcher-list">
            <p class="placeholder-text">Loading workspaces...</p>
        </div>
    </div>
</div>

<!-- ── Top Navigation Bar ─────────────────────────────────────── -->
<nav id="nav-bar" class="hidden">
    <div class="nav-controls">
        <button id="btn-back" title="Back">&#9664;</button>
        <button id="btn-forward" title="Forward">&#9654;</button>
        <button id="btn-refresh" title="Refresh">&#8635;</button>
    </div>
    <div class="url-bar">
        <input type="text" id="url-input" placeholder="Enter URL..." spellcheck="false">
        <button id="btn-go">Go</button>
    </div>
    <div class="nav-status">
        <button id="btn-switch-ws" class="btn-small" title="Switch workspace">Switch</button>
        <span id="ws-active-name" class="ws-badge"></span>
        <span id="connection-status" class="status-dot disconnected" title="Backend connection"></span>
    </div>
</nav>

<!-- ── Tool Panel (left side) ─────────────────────────────────── -->
<div id="tool-panel" class="hidden">

    <!-- Tab bar (rendered dynamically by app.js) -->
    <div id="tab-bar"></div>

    <!-- Tab content -->
    <div id="tab-content">

        <!-- Logs -->
        <div class="tab-pane active" data-tab="logs">
            <div class="pane-controls">
                <input type="text" id="log-search" placeholder="Filter logs...">
                <select id="log-method-filter">
                    <option value="">All</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <button id="btn-clear-logs" title="Clear all logs">Clear</button>
            </div>
            <div id="log-list" class="scrollable"></div>
        </div>

        <!-- Site Map -->
        <div class="tab-pane" data-tab="sitemap">
            <div class="pane-controls">
                <button id="btn-start-crawl">Crawl</button>
                <button id="btn-stop-crawl" disabled>Stop</button>
                <span id="crawl-status" class="status-label">Idle</span>
            </div>
            <div id="site-tree" class="scrollable"></div>
        </div>

        <!-- Intercept -->
        <div class="tab-pane" data-tab="intercept">
            <div class="pane-controls intercept-controls">
                <button id="btn-intercept-toggle" class="btn-primary intercept-off">Intercept Off</button>
                <span id="intercept-queue-count" class="badge" style="display:none">0 queued</span>
                <span id="intercept-status" class="status-label">Disabled</span>
            </div>
            <div id="intercept-current" class="intercept-editor hidden">
                <div class="intercept-phase-row">
                    <span id="intercept-phase-badge" class="badge badge-request">REQUEST</span>
                    <span id="intercept-host" class="status-label"></span>
                </div>
                <div class="form-group">
                    <label>Method + URL</label>
                    <div class="form-row" style="gap:6px">
                        <select id="intercept-method" style="flex:0 0 80px">
                            <option>GET</option><option>POST</option>
                            <option>PUT</option><option>DELETE</option>
                            <option>PATCH</option><option>OPTIONS</option>
                            <option>HEAD</option>
                        </select>
                        <input type="text" id="intercept-url" style="flex:1" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Headers</label>
                    <textarea id="intercept-headers" rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label>Body</label>
                    <textarea id="intercept-body" rows="6"></textarea>
                </div>
                <div id="intercept-response-section" class="hidden">
                    <div class="form-group">
                        <label>Response Status</label>
                        <input type="number" id="intercept-resp-status" style="width:100px">
                    </div>
                    <div class="form-group">
                        <label>Response Headers</label>
                        <textarea id="intercept-resp-headers" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Response Body</label>
                        <textarea id="intercept-resp-body" rows="6"></textarea>
                    </div>
                </div>
                <div class="intercept-actions">
                    <button id="btn-intercept-forward" class="btn-primary">Forward</button>
                    <button id="btn-intercept-drop" class="btn-small danger">Drop</button>
                </div>
            </div>
            <div id="intercept-empty" class="intercept-placeholder">
                <p class="placeholder-text">Intercept is disabled. Toggle above to start intercepting proxy traffic.</p>
            </div>
            <div id="intercept-history" class="scrollable"></div>
        </div>

        <!-- Injector -->
        <div class="tab-pane" data-tab="injector">
            <div id="injector-config">
                <div class="form-group">
                    <label>Target URL</label>
                    <input type="text" id="inject-url" placeholder="https://target.com/api/endpoint">
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label>Method</label>
                        <select id="inject-method">
                            <option>GET</option><option>POST</option>
                            <option>PUT</option><option>DELETE</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label>Injector</label>
                        <select id="inject-type">
                            <option value="quick">Quick Scan</option>
                            <option value="sql">SQL</option>
                            <option value="aql">AQL</option>
                            <option value="xss">XSS</option>
                            <option value="mongo">MongoDB</option>
                            <option value="jwt">JWT</option>
                            <option value="ssti">SSTI</option>
                            <option value="cmd">Command</option>
                            <option value="traversal">Path Traversal</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Params (JSON)</label>
                    <textarea id="inject-params" rows="2" placeholder='{"key": "value"}'></textarea>
                </div>
                <div class="form-group">
                    <label>Headers (JSON)</label>
                    <textarea id="inject-headers" rows="2" placeholder='{"Authorization": "Bearer ..."}'></textarea>
                </div>
                <div class="form-group">
                    <label>Body</label>
                    <textarea id="inject-body" rows="2" placeholder="Request body..."></textarea>
                </div>
                <div class="form-group">
                    <label>Injection Points</label>
                    <div id="injection-points" class="checkbox-group">
                        <label><input type="checkbox" value="params" checked> Params</label>
                        <label><input type="checkbox" value="paths"> Paths</label>
                        <label><input type="checkbox" value="headers"> Headers</label>
                        <label><input type="checkbox" value="body"> Body</label>
                    </div>
                </div>
                <div class="form-group" id="key-picker-group" style="display:none">
                    <label>Target Keys <span class="hint">(uncheck to exclude from injection)</span></label>
                    <div id="key-picker" class="key-picker-table"></div>
                </div>
                <div class="scan-controls">
                    <button id="btn-send-single" class="btn-small">Send Request</button>
                    <button id="btn-start-scan" class="btn-primary">Launch Scan</button>
                    <button id="btn-pause-scan" class="btn-small hidden">Pause</button>
                    <button id="btn-stop-scan" class="btn-small danger hidden">Stop</button>
                </div>
            </div>
            <div id="scan-results-toolbar" class="pane-controls hidden">
                <input type="text" id="scan-text-filter" placeholder="Filter results...">
                <button id="btn-analyze-filtered" class="btn-small">Analyze Filtered</button>
            </div>
            <div id="scan-results" class="scrollable"></div>
        </div>

        <!-- Repeater -->
        <div class="tab-pane" data-tab="repeater">
            <div class="repeater-layout">
                <div class="repeater-list-panel">
                    <div class="pane-controls">
                        <span style="font-weight:600;font-size:12px">History</span>
                    </div>
                    <div id="repeater-list" class="scrollable"></div>
                </div>
                <div class="repeater-editor-panel">
                    <div class="form-group">
                        <div class="form-row" style="gap:6px">
                            <select id="repeater-method" style="flex:0 0 80px">
                                <option>GET</option><option>POST</option>
                                <option>PUT</option><option>DELETE</option>
                                <option>PATCH</option>
                            </select>
                            <input type="text" id="repeater-url" placeholder="https://..." style="flex:1">
                            <button id="btn-repeater-send" class="btn-primary" style="flex:0 0 70px;width:auto">Send</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Headers (JSON)</label>
                        <textarea id="repeater-headers" rows="3" placeholder='{"Authorization": "Bearer ..."}'></textarea>
                    </div>
                    <div class="form-group">
                        <label>Body</label>
                        <textarea id="repeater-body" rows="4" placeholder="Request body..."></textarea>
                    </div>
                    <div id="repeater-response" class="scrollable"></div>
                </div>
            </div>
        </div>

        <!-- Credentials -->
        <!-- Analytics -->
        <div class="tab-pane" data-tab="analytics">
            <div id="analytics-filter-bar" class="pane-controls hidden">
                <span id="analytics-filter-label" class="status-label" style="flex:1"></span>
                <button id="btn-analytics-full" class="btn-small">Show Full Analysis</button>
            </div>
            <div id="analytics-body-content" class="scrollable"></div>
        </div>

        <div class="tab-pane" data-tab="settings">
            <div class="settings-scroll scrollable">

                <!-- Tab Configuration -->
                <div class="settings-section">
                    <div class="settings-section-title">Tabs</div>
                    <p style="font-size:11px;color:var(--text-dim);margin-bottom:8px">Drag to reorder. Uncheck to hide. Settings tab is always visible.</p>
                    <div id="tab-config-list"></div>
                    <button id="btn-save-tab-config" class="btn-primary" style="margin-top:8px;width:auto;padding:0 16px">Save Tab Layout</button>
                </div>

                <!-- Proxy / Intercept Settings -->
                <div class="settings-section">
                    <div class="settings-section-title">Intercept</div>
                    <label class="toggle-row">
                        <input type="checkbox" id="chk-intercept-requests" checked>
                        <span>Intercept outgoing requests</span>
                    </label>
                    <label class="toggle-row" style="margin-top:6px">
                        <input type="checkbox" id="chk-intercept-responses" checked>
                        <span>Intercept incoming responses</span>
                    </label>
                    <label class="toggle-row" style="margin-top:6px">
                        <input type="checkbox" id="chk-auto-drop-options" checked>
                        <span>Auto-forward OPTIONS requests</span>
                    </label>
                    <p style="font-size:11px;color:var(--text-dim);margin-top:4px">Choose which phases to pause for inspection. OPTIONS auto-forward keeps CORS preflights out of the intercept queue.</p>
                </div>

                <!-- Injector Payloads -->
                <div class="settings-section">
                    <div class="settings-section-title">Injector Payloads</div>
                    <p style="font-size:11px;color:var(--text-dim);margin-bottom:8px">Customize which payloads each injector uses for this workspace.</p>
                    <div id="injector-payload-list"></div>
                </div>

                <!-- Data Management -->
                <div class="settings-section">
                    <div class="settings-section-title">Data Management</div>
                    <table class="data-mgmt-table">
                        <tbody>
                            <tr>
                                <td class="data-mgmt-label">Request Logs</td>
                                <td class="data-mgmt-desc">Captured proxy traffic for this workspace</td>
                                <td class="data-mgmt-action"><button id="btn-clear-logs-all" class="btn-small danger">Clear</button></td>
                            </tr>
                            <tr>
                                <td class="data-mgmt-label">Site Map</td>
                                <td class="data-mgmt-desc">Discovered URLs and crawl results</td>
                                <td class="data-mgmt-action"><button id="btn-clear-sitemap" class="btn-small danger">Clear</button></td>
                            </tr>
                            <tr>
                                <td class="data-mgmt-label">Injector History</td>
                                <td class="data-mgmt-desc">Saved scan results and payloads</td>
                                <td class="data-mgmt-action"><button id="btn-clear-injector-history" class="btn-small danger">Clear</button></td>
                            </tr>
                            <tr>
                                <td class="data-mgmt-label">Repeater History</td>
                                <td class="data-mgmt-desc">Saved manual request entries</td>
                                <td class="data-mgmt-action"><button id="btn-clear-repeater-history" class="btn-small danger">Clear</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Credentials -->
                <div class="settings-section">
                    <div class="settings-section-title">Credentials</div>
                    <div class="pane-controls" style="border-bottom:none;padding:0 0 8px">
                        <button id="btn-add-cred">+ Add</button>
                        <input type="text" id="cred-search" placeholder="Filter by site...">
                    </div>
                    <div id="cred-form" class="cred-form hidden">
                        <input type="hidden" id="cred-edit-id" value="">
                        <div class="form-row">
                            <div class="form-group half">
                                <label>Site / Domain</label>
                                <input type="text" id="cred-site" placeholder="example.com">
                            </div>
                            <div class="form-group half">
                                <label>Auth Type</label>
                                <select id="cred-auth-type">
                                    <option value="basic">Basic (user/pass)</option>
                                    <option value="bearer">Bearer Token</option>
                                    <option value="api_key">API Key</option>
                                    <option value="cookie">Cookie</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half">
                                <label>Username</label>
                                <input type="text" id="cred-username" placeholder="admin">
                            </div>
                            <div class="form-group half">
                                <label>Password</label>
                                <input type="password" id="cred-password" placeholder="********">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Token / API Key</label>
                            <input type="text" id="cred-token" placeholder="Bearer eyJ...">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input type="text" id="cred-notes" placeholder="Optional notes">
                        </div>
                        <div class="form-row">
                            <button id="btn-save-cred" class="btn-primary" style="flex:1">Save</button>
                            <button id="btn-cancel-cred" class="btn-small" style="flex:0">Cancel</button>
                        </div>
                    </div>
                    <div id="cred-list"></div>
                </div>

                <!-- Export -->
                <div class="settings-section">
                    <div class="settings-section-title">Export</div>
                    <button id="btn-open-export" class="btn-primary btn-export-full">Export Data...</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Detail panel (bottom drawer) -->
    <div id="detail-panel" class="collapsed">
        <div id="detail-header">
            <span id="detail-title">Request Details</span>
            <button id="btn-close-detail">&#10005;</button>
        </div>
        <div id="detail-content" class="scrollable">
            <p class="placeholder-text">Select a request to view details</p>
        </div>
    </div>
</div>

<!-- Drag handle to resize tool panel / browser split -->
<div id="panel-resize-handle"></div>


<!-- ── Export Modal ────────────────────────────────────────────── -->
<div id="export-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Export Data</h3>
            <button id="btn-export-close" class="btn-small">&times;</button>
        </div>
        <div class="modal-body">
            <div id="export-site-filter" class="form-group hidden" style="background:var(--bg);padding:8px 10px;border-radius:4px;margin-bottom:10px">
                <label style="font-size:11px;color:var(--text-dim);margin:0">Filtered to site: <strong id="export-site-label"></strong></label>
                <button id="btn-export-clear-filter" class="btn-small" style="margin-left:8px;font-size:10px">Clear filter</button>
            </div>
            <div class="form-group">
                <label>What to export</label>
                <div class="checkbox-group" style="flex-direction:column;gap:6px">
                    <label><input type="checkbox" value="logs" checked> Request Logs</label>
                    <label><input type="checkbox" value="scans" checked> Scan Results</label>
                    <label><input type="checkbox" value="sitemap"> Site Map URLs</label>
                    <label><input type="checkbox" value="credentials"> Credentials</label>
                    <label><input type="checkbox" value="repeater"> Repeater History</label>
                </div>
            </div>
            <div class="form-group">
                <label>Format</label>
                <select id="export-format">
                    <option value="json">JSON</option>
                    <option value="postman">Postman Collection (endpoints only)</option>
                    <option value="csv">CSV (logs &amp; scans only)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btn-export-run" class="btn-primary" style="width:auto;padding:0 20px">Export</button>
        </div>
    </div>
</div>

<!-- ── Endpoint Export Modal (from site map) ──────────────────── -->
<div id="endpoint-export-modal" class="modal-overlay hidden">
    <div class="modal-card" style="width:320px">
        <div class="modal-header">
            <h3>Export Endpoints</h3>
            <button id="btn-ep-export-close" class="btn-small">&times;</button>
        </div>
        <div class="modal-body">
            <p id="ep-export-site" style="font-size:12px;color:var(--text-dim);margin:0 0 10px"></p>
            <div class="form-group">
                <label>Format</label>
                <select id="ep-export-format">
                    <option value="postman">Postman Collection</option>
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btn-ep-export-run" class="btn-primary" style="width:auto;padding:0 20px">Export</button>
        </div>
    </div>
</div>

<!-- ── Payload Editor Modal ────────────────────────────────────── -->
<div id="payload-editor-modal" class="modal-overlay hidden">
    <div class="modal-card" style="width:560px;max-height:85vh">
        <div class="modal-header">
            <h3 id="payload-editor-title">Edit Payloads</h3>
            <button id="btn-payload-editor-close" class="btn-small">&times;</button>
        </div>
        <div class="payload-editor-toolbar">
            <input type="text" id="payload-search" placeholder="Filter payloads...">
            <button id="btn-payload-add" class="btn-small">+ Add</button>
            <button id="btn-payload-reset" class="btn-small danger">Reset to Defaults</button>
        </div>
        <div id="payload-editor-stats" class="payload-editor-stats"></div>
        <div id="payload-editor-list" class="scrollable payload-editor-list"></div>
        <div id="payload-add-form" class="payload-add-form hidden">
            <textarea id="payload-add-text" rows="2" placeholder="Enter new payload..."></textarea>
            <div class="payload-add-controls">
                <label><input type="checkbox" id="payload-add-quick"> Quick scan</label>
                <button id="btn-payload-add-confirm" class="btn-primary" style="width:auto;padding:0 16px">Add Payload</button>
                <button id="btn-payload-add-cancel" class="btn-small">Cancel</button>
            </div>
        </div>
        <div class="modal-footer">
            <span id="payload-customized-badge" class="badge hidden" style="margin-right:auto">Customized</span>
            <button id="btn-payload-save" class="btn-primary" style="width:auto;padding:0 20px">Save Changes</button>
        </div>
    </div>
</div>

<script src="js/workspace.js"></script>
<script src="js/send-to.js"></script>
<script src="js/log-viewer.js"></script>
<script src="js/site-map.js"></script>
<script src="js/intercept.js"></script>
<script src="js/injector-ui.js"></script>
<script src="js/repeater.js"></script>
<script src="js/credentials.js"></script>
<script src="js/analytics.js"></script>
<script src="js/payload-editor.js"></script>
<script src="js/app.js"></script>
</body>
</html>
